<div class="chat-container" *ngIf="intercambio">
  <!-- Encabezado con info y acciones -->
  <div class="chat-header">
    <div class="header-left">
      <button class="btn btn-back" (click)="volver()">
        ‚Üê Volver a intercambios
      </button>

      <div class="user-block">
        <div class="titulo-chat">
          Chat con
          {{
            intercambio?.yo_soy_ofertante
              ? intercambio?.usuario_recibe?.nombre
              : intercambio?.usuario_ofrece?.nombre
          }}
        </div>
        <div class="estado-chat">
          Estado actual: {{ intercambio?.estado }}
        </div>
      </div>
    </div>

    <div class="header-right">
      <button class="btn btn-cancelar" (click)="cancelar()">
        Cancelar este intercambio
      </button>
      <button
        class="btn btn-confirmar"
        (click)="finalizar()"
        [disabled]="yaConfirmeYo || estadoIntercambio === 'aceptado' || estadoIntercambio === 'cancelado'"
      >
        Confirmar que ya recib√≠ el producto
      </button>
    </div>
  </div>

  <!-- Aviso de funcionamiento -->
  <div class="notice">
    <strong>Importante:</strong>
    Usa este chat √∫nicamente para coordinar lugar, fecha y hora del
    intercambio. Pulsa
    <span class="tag">"Confirmar que ya recib√≠ el producto"</span> solo
    cuando ya tengas el producto del otro usuario.
    <br />
    El sistema marcar√° el intercambio como <strong>finalizado</strong> cuando
    <strong>ambas partes</strong> hayan confirmado. Trueque no se hace
    responsable si alguno de los usuarios no cumple con el acuerdo o no
    confirma el intercambio.
  </div>

  <!-- Resumen de productos con im√°genes -->
  <div class="resumen-productos">
    <div class="resumen-col">
      <h4>T√∫ ofreces</h4>

      <div class="resumen-producto">
        <img
          *ngIf="intercambio?.producto_ofrece?.imagen"
          class="resumen-img"
          [src]="resolverImagen(intercambio?.producto_ofrece?.imagen || null)"
          alt="Producto que ofreces"
        />
        <p>
          {{ intercambio?.producto_ofrece?.titulo || "Solo diferencia en dinero" }}
        </p>
      </div>
    </div>

    <div class="resumen-col">
      <h4>T√∫ recibes</h4>

      <div class="resumen-producto">
        <img
          *ngIf="intercambio?.producto_objetivo?.imagen"
          class="resumen-img"
          [src]="resolverImagen(intercambio?.producto_objetivo?.imagen || null)"
          alt="Producto que recibes"
        />
        <p>{{ intercambio?.producto_objetivo?.titulo }}</p>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  <div id="chat-scroll" class="chat-mensajes">
    <div
      *ngFor="let m of mensajes"
      [ngClass]="{ 'mensaje-mio': esMio(m), 'mensaje-otro': !esMio(m) }"
      class="mensaje"
    >
      <div class="bubble" *ngIf="m.tipo === 'texto'">
        {{ m.contenido }}
      </div>

      <div class="bubble ubicacion" *ngIf="m.tipo === 'ubicacion'">
        <span>üìç Ubicaci√≥n enviada</span>
        <button class="btn btn-mapa" (click)="abrirMapa(m)">
          Ver en mapa
        </button>
      </div>

      <div class="hora">
        {{ m.creado | date: "shortTime" }}
      </div>
    </div>
  </div>

  <!-- Input de chat -->
  <div class="chat-input">
    <input
      type="text"
      [(ngModel)]="nuevoMensaje"
      placeholder="Escribe un mensaje..."
      (keyup.enter)="enviarTexto()"
    />
    <button class="btn btn-chat" (click)="enviarTexto()">Enviar</button>
    <button class="btn btn-ubicacion" (click)="enviarUbicacion()">
      Enviar ubicaci√≥n
    </button>
  </div>
</div>

<!-- OVERLAY: esperando confirmaci√≥n del otro -->
<div class="overlay" *ngIf="mostrandoEsperando">
  <div class="overlay-card">
    <h2>¬°Gracias por usar Trueque! üéâ</h2>
    <p>Ya marcaste este intercambio como realizado.</p>
    <p>Ahora estamos esperando a que la otra persona confirme tambi√©n.</p>

    <div class="overlay-timer" *ngIf="deadline">
      <p>
        El otro usuario tiene
        <strong>{{ contador }}</strong>
        para confirmar.
      </p>
      <small>
        Si no confirma a tiempo, su cuenta ser√° dada de baja autom√°ticamente.
      </small>
    </div>

    <button class="btn-ir" (click)="irATienda()">
      Seguir explorando productos
    </button>
  </div>
</div>

<!-- OVERLAY: intercambio completado -->
<div class="overlay" *ngIf="mostrandoExito">
  <div class="overlay-card success">
    <h2>Intercambio completado ‚úÖ</h2>
    <p>Ambos han confirmado que el intercambio se realiz√≥ correctamente.</p>
    <p>¬°Gracias por confiar en Trueque! Sigue explorando nuevos productos.</p>

    <button class="btn-ir" (click)="irATienda()">
      Ir a la tienda
    </button>
  </div>
</div>

<!-- OVERLAY: intercambio cancelado -->
<div class="overlay" *ngIf="mostrandoCancelado">
  <div class="overlay-card warning">
    <h2>Intercambio cancelado</h2>
    <p>
      Este intercambio ha sido cancelado. Puedes seguir explorando otros
      productos y crear nuevos intercambios.
    </p>

    <button class="btn-ir" (click)="irATienda()">
      Volver a la tienda
    </button>
  </div>
</div>



